#include <lgr_element_functions.hpp>
#include "lgr_gtest.hpp"

using Omega_h::are_close;

template <int M, int N>
static bool is_close(Omega_h::Matrix<M, N> a, Omega_h::Matrix<M, N> b) {
  bool close = true;
  for (int i = 0; i < M; ++i) {
    for (int j = 0; j < N; ++j) {
      if (! are_close(a(i, j), b(i, j))) {
        close = false;
      }
    }
  }
  return close;
}

static Omega_h::Matrix<3, 3> I3x3() {
  Omega_h::Matrix<3, 3> I = Omega_h::zero_matrix<3, 3>();
  for (int i = 0; i < 3; ++i) {
    I(i, i) = 1.0;
  }
  return I;
}

static Omega_h::Matrix<3, 10> get_parametric_coords() {
  Omega_h::Matrix<3, 10> xi;
  xi[0][0] = 0.0; xi[0][1] = 0.0; xi[0][2] = 0.0;
  xi[1][0] = 1.0; xi[1][1] = 0.0; xi[1][2] = 0.0;
  xi[2][0] = 0.0; xi[2][1] = 1.0; xi[2][2] = 0.0;
  xi[3][0] = 0.0; xi[3][1] = 0.0; xi[3][2] = 1.0;
  xi[4][0] = 0.5; xi[4][1] = 0.0; xi[4][2] = 0.0;
  xi[5][0] = 0.5; xi[5][1] = 0.5; xi[5][2] = 0.0;
  xi[6][0] = 0.0; xi[6][1] = 0.5; xi[6][2] = 0.0;
  xi[7][0] = 0.0; xi[7][1] = 0.0; xi[7][2] = 0.5;
  xi[8][0] = 0.5; xi[8][1] = 0.0; xi[8][2] = 0.5;
  xi[9][0] = 0.0; xi[9][1] = 0.5; xi[9][2] = 0.5;
  return xi;
}

static Omega_h::Matrix<3, 10> get_reference_coords() {
  Omega_h::Matrix<3, 10> X;
  X[0][0] = -0.05;    X[0][1] = -0.1;     X[0][2] = 0.125;
  X[1][0] = 0.9;      X[1][1] = 0.025;    X[1][2] = -0.075;
  X[2][0] = -0.1;     X[2][1] = 1.025;    X[2][2] = -0.075;
  X[3][0] = 0.125;    X[3][1] = 0.1;      X[3][2] = 1.025;
  X[4][0] = 0.525;    X[4][1] = 0.025;    X[4][2] = -0.05;
  X[5][0] = 0.5;      X[5][1] = 0.525;    X[5][2] = 0.05;
  X[6][0] = 0.125;    X[6][1] = 0.45;     X[6][2] = -0.075;
  X[7][0] = 0.1;      X[7][1] = 0.075;    X[7][2] = 0.575;
  X[8][0] = 0.475;    X[8][1] = -0.075;   X[8][2] = 0.55;
  X[9][0] = -0.075;   X[9][1] = 0.6;      X[9][2] = 0.45;
  return X;
}

static lgr::CompTet::OType gold_O_reference() {
  lgr::CompTet::OType O;
  O[0] = {1.1500000000000001, 0.35, 0.30000000000000004,
    0.25, 1.1, 0.35,
    -0.35, -0.4, 0.8999999999999999};
  O[1] = {0.75, -0.050000000000000044, -0.10000000000000009,
    0., 1., -0.2,
    -0.04999999999999999, 0.2, 1.2000000000000002};
  O[2] = {0.75, -0.45, -0.4,
    0.15000000000000002, 1.15, 0.29999999999999993,
    0.25, 0., 1.05};
  O[3] = {0.75, -0.35, 0.04999999999999999,
    -0.3, 1.05, 0.05000000000000002,
    -0.04999999999999982, -0.2499999999999999, 0.8999999999999999};
  O[4] = {0.8500000000000001, -0.050000000000000044, -0.10000000000000009,
    -0.16666666666666669, 1., -0.2,
    0.20000000000000012, 0.2, 1.2000000000000002};
  O[5] = {0.8500000000000001, -0.24999999999999994, -0.30000000000000004,
    -0.16666666666666669, 1.1833333333333331, -0.01666666666666672,
    0.20000000000000012, 0., 1.};
  O[6] = {0.75, -0.35, -0.30000000000000004,
    -0.3, 1.05, -0.01666666666666672,
    -0.04999999999999982, -0.2499999999999999, 1.};
  O[7] = {0.75, -0.14999999999999997, -0.10000000000000009,
    -0.3, 0.8666666666666667, -0.2,
    -0.04999999999999982, -0.04999999999999988, 1.2000000000000002};
  O[8] = {0.75, -0.050000000000000044, -0.2,
    0.15000000000000002, 1., 0.11666666666666664,
    0.25, 0.2, 1.25};
  O[9] = {0.75, -0.24999999999999994, -0.4,
    0.15000000000000002, 1.1833333333333331, 0.29999999999999993,
    0.25, 0., 1.05};
  O[10] = {0.65, -0.35, -0.4,
    0.016666666666666663, 1.05, 0.29999999999999993,
    5.551115123125783e-17, -0.2499999999999999, 1.05};
  O[11] = {0.65, -0.14999999999999997, -0.2,
    0.016666666666666663, 0.8666666666666667, 0.11666666666666664,
    5.551115123125783e-17, -0.04999999999999988, 1.25};
  return O;
}

static Omega_h::Matrix<4, 4> gold_M_inv_parametric() {
  Omega_h::Matrix<4, 4> M_inv = {
    96.0, -24.0, -24.0, -24.0,
    -24.0, 96.0, -24.0, -24.0,
    -24.0, -24.0, 96.0, -24.0,
    -24.0, -24.0, -24.0, 96.0 };
  return M_inv;
}

static Omega_h::Matrix<4, 4> gold_M_inv_reference() {
  Omega_h::Matrix<4, 4> M_inv = {
    88.06190094134685, -22.157433523004897, -20.91267757241373, -25.784431612729065,
    -22.157433523004897, 103.03437794530312, -25.450695338505415, -31.249163121001295,
    -20.912677572413727, -25.45069533850542, 95.7216646218602, -29.950895484185008,
    -25.78443161272906, -31.249163121001292, -29.95089548418501, 131.22814250271662 };
  return M_inv;
}

static Omega_h::Few<Omega_h::Matrix<10, 3>, 4> gold_B_parametric() {
  Omega_h::Few<Omega_h::Matrix<10, 3>, 4> B;
  B[0] = {
    -1.0885254915624212, -1.0885254915624212, -1.0885254915624212,
    -0.029508497187473802, 0., 0.,
    0., -0.02950849718747367, 0.,
    0., 0., -0.02950849718747367,
    1.3043729868748781, -0.5636610018750173, -0.5636610018750172,
    0.37732200375003533, 0.37732200375003544, 0.18633899812498256,
    -0.5636610018750176, 1.3043729868748781, -0.5636610018750173,
    -0.5636610018750176, -0.5636610018750177, 1.3043729868748781,
    0.37732200375003533, 0.1863389981249825, 0.37732200375003483,
    0.18633899812498256, 0.3773220037500351, 0.3773220037500353 };
  B[1] = {
    0.029508497187473726, 0.029508497187473726, 0.029508497187473726,
    1.0885254915624212, 0., 0.,
    0., -0.029508497187473726, 0.,
    0., 0., -0.02950849718747367,
    -1.3043729868748768, -1.8680339887498947, -1.8680339887498947,
    0.5636610018750178, 1.8680339887498953, 5.551115123125783e-17,
    -0.37732200375003533, 4.440892098500626e-16, -0.1909830056250525,
    -0.37732200375003555, -0.1909830056250526, 4.440892098500626e-16,
    0.5636610018750179, 0., 1.8680339887498951,
    -0.18633899812498256, 0.19098300562505288, 0.19098300562505266 };
  B[2] = {
    0.029508497187473726, 0.029508497187473726, 0.029508497187473726,
    -0.02950849718747385, 0., 0.,
    0., 1.088525491562422, 0.,
    0., 0., -0.029508497187473948,
    8.881784197001252e-16, -0.3773220037500351, -0.19098300562505222,
    1.8680339887498962, 0.5636610018750181, 1.6653345369377348e-16,
    -1.8680339887498958, -1.3043729868748777, -1.8680339887498953,
    -0.19098300562505266, -0.3773220037500351, 8.881784197001252e-16,
    0.1909830056250525, -0.18633899812498256, 0.19098300562505224,
    5.551115123125783e-17, 0.5636610018750179, 1.8680339887498962 };
  B[3] = {
    0.029508497187473726, 0.029508497187473726, 0.029508497187473726,
    -0.02950849718747382, 0., 0.,
    0., -0.029508497187473948, 0.,
    0., 0., 1.0885254915624218,
    8.881784197001252e-16, -0.19098300562505233, -0.3773220037500351,
    0.1909830056250525, 0.19098300562505294, -0.1863389981249825,
    -0.1909830056250525, 8.881784197001252e-16, -0.3773220037500348,
    -1.8680339887498953, -1.8680339887498956, -1.3043729868748772,
    1.8680339887498962, 1.1102230246251565e-16, 0.5636610018750177,
    5.551115123125783e-17, 1.8680339887498965, 0.5636610018750174 };
  return B;
}

static Omega_h::Few<Omega_h::Matrix<10, 3>, 4> gold_B_reference() {
  Omega_h::Few<Omega_h::Matrix<10, 3>, 4> B;
  B[0] = {
    -1.0648824950666589, -1.0399437949480013, -0.640924593049488,
    -0.018664096396885058, -0.0006020676257059647, -0.0016556859706914177,
    0.0014179073504135935, -0.015253245739297594, 0.004898225392337863,
    0.0011384880198377773, 0.0018305101495430798, 0.006094259400308111,
    1.3392452775560804, -0.8722563474196265, -0.5012017528993882,
    0.4209992752085011, 0.39578371289233083, 0.16369100464323705,
    -0.9305464535486132, 1.169517951697121, -0.8050215736397817,
    -0.42891924375489504, -0.2910852712370233, 1.2050898962095027,
    0.47304675460311896, 0.25209578782020536, 0.3150060352063141,
    0.2071645860291014, 0.3999127644104547, 0.2540241847076482 };
  B[1] = {
    0.018984779835164556, 0.018540171408111816, 0.011426436575262822,
    1.4420329787297366, 0.046517192862249625, 0.1279222803711864,
    0.003951054020665663, -0.04250376294958502, 0.013649095707754091,
    -0.003877228568955747, -0.006233975346164142, -0.020754576457351348,
    -1.743528190523818, -1.679764944007974, -1.9149700293205414,
    0.7878941834497728, 1.8728651886534406, 0.32662147042377887,
    -0.40275421819072654, 0.05927573833313504, -0.2185891438494107,
    -0.5285039068897748, -0.26716092328271823, -0.13327376778177147,
    0.6555167899662965, -0.14504376271545202, 1.650359397524035,
    -0.2297162418283609, 0.14350907704495575, 0.15760883680705584 };
  B[2] = {
    0.018464278841961113, 0.018031860133719047, 0.01111316080183622,
    -0.05613344841798203, -0.0018107564005800617, -0.00497958010159519,
    -0.08827132906359149, 0.9495855096234842, -0.30493731858331596,
    -0.003751493876278121, -0.006031813683427589, -0.020081526043606468,
    0.14135907370507228, -0.282278726371028, -0.07950846474675,
    2.187936155511044, 1.1507380168180394, 0.4931115295810625,
    -1.6944235744124883, -1.6855740318057926, -1.878816778955477,
    -0.21730512291293197, -0.3800957866219834, -0.022045356231889635,
    0.15790254279184804, -0.11348156975137227, 0.2631952296250232,
    -0.4457770821666528, 0.35091729805894134, 1.542949104654712 };
  B[3] = {
    0.0051636024256369595, 0.005042674968362526, 0.0031078356519642636,
    -0.05138982280650779, -0.0016577362195647652, -0.004558774603803117,
    0.003554092155000809, -0.03823341560682669, 0.012277772899093667,
    0.19509069268300508, 0.3136752313726753, 1.0443090020090293,
    -0.07331027267952006, -0.27292868112926216, -0.4223527675932898,
    0.42979882880380693, 0.3283088860116344, -0.07278268268201485,
    -0.31660739714847896, -0.17324430247401867, -0.4915805285062043,
    -3.487492198468569, -3.0714436875576245, -1.3760082067494905,
    2.6936930039094498, 0.8816917260243936, 0.782166360452026,
    0.6014994711261776, 2.0287893046102314, 0.5254219891226886 };
  return B;
}

TEST(composite_tet, O_parametric) {
  auto I = I3x3();
  auto X = get_parametric_coords();
  auto S = lgr::CompTet::compute_S();
  auto O = lgr::CompTet::compute_O(X, S);
  for (int tet = 0; tet < lgr::CompTet::nsub_tets; ++tet) {
    EXPECT_TRUE(is_close(O[tet], I));
  }
}

TEST(composite_tet, O_reference) {
  auto X = get_reference_coords();
  auto S = lgr::CompTet::compute_S();
  auto O = lgr::CompTet::compute_O(X, S);
  auto O_gold = gold_O_reference();
  for (int tet = 0; tet < lgr::CompTet::nsub_tets; ++tet) {
    EXPECT_TRUE(is_close(O[tet], O_gold[tet]));
  }
}

TEST(composite_tet, M_inv_parametric) {
  auto X = get_parametric_coords();
  auto S = lgr::CompTet::compute_S();
  auto O = lgr::CompTet::compute_O(X, S);
  auto O_det = lgr::CompTet::compute_O_det(O);
  auto M_inv = lgr::CompTet::compute_M_inv(O_det);
  auto M_inv_gold = gold_M_inv_parametric();
  EXPECT_TRUE(is_close(M_inv, M_inv_gold));
}

TEST(composite_tet, M_inv_reference) {
  auto X = get_reference_coords();
  auto S = lgr::CompTet::compute_S();
  auto O = lgr::CompTet::compute_O(X, S);
  auto O_det = lgr::CompTet::compute_O_det(O);
  auto M_inv = lgr::CompTet::compute_M_inv(O_det);
  auto M_inv_gold = gold_M_inv_reference();
  EXPECT_TRUE(is_close(M_inv, M_inv_gold));
}

TEST(composite_tet, B_parametric) {
  auto I = I3x3();
  auto X = get_parametric_coords();
  auto shape = lgr::CompTet::shape(X);
  auto B_gold = gold_B_parametric();
  for (int pt = 0; pt < lgr::CompTet::points; ++pt) {
    auto BT = shape.basis_gradients[pt];
    auto B = Omega_h::transpose(BT);
    auto result = X * B;
    EXPECT_TRUE(is_close(result, I));
    EXPECT_TRUE(is_close(B, B_gold[pt]));
  }
}

TEST(composite_tet, B_reference) {
  auto I = I3x3();
  auto X = get_reference_coords();
  auto shape = lgr::CompTet::shape(X);
  auto B_gold = gold_B_reference();
  for (int pt = 0; pt < lgr::CompTet::points; ++pt) {
    auto BT = shape.basis_gradients[pt];
    auto B = Omega_h::transpose(BT);
    auto result = X * B;
    EXPECT_TRUE(is_close(result, I));
    EXPECT_TRUE(is_close(B, B_gold[pt]));
  }
}
